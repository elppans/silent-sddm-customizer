#!/bin/bash

# Verifica se o script está sendo executado como root
if [ "$EUID" -eq 0 ]; then
    echo "Erro: Este script não deve ser executado como superusuário (root)."
    echo "Por favor, execute como um usuário normal."
	echo "Se necessário, será pedido a senha administrativa!"
    exit 1
fi

# Dependência: imagemagick
if ! command -v magick &> /dev/null; then
    echo "Erro: 'imagemagick' não instalado."
    exit 1
fi

if [ -z "$1" ]; then
    echo "Uso: faceconv imagem.jpg"
    exit 1
fi

SOURCE_IMG="$1"
TARGET_IMG="$HOME/.face.icon"

echo "Processando imagem para avatar..."

if magick "$SOURCE_IMG" \
    -resize "256x256^" \
    -gravity center \
    -extent 256x256 \
    -strip \
    -alpha on \
    PNG32:"$TARGET_IMG"; then

    # Se o comando acima deu certo, executa os ajustes:
    chmod 644 "$TARGET_IMG"
    
    # Checa permissão da Home (permissão de execução 'x' para outros)
    HOME_PERM=$(stat -c "%a" "$HOME")
    if [[ "${HOME_PERM: -1}" -lt 1 ]]; then
        echo "Ajustando permissão da Home para o SDDM..."
        sudo chmod a+x "$HOME"
    fi

    echo "Finalizado! Avatar atualizado em $TARGET_IMG."
else
    echo "Erro na conversão. Verifique o arquivo de origem."
    exit 1
fi